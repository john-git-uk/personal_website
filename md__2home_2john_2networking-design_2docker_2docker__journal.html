<!-- HTML header for doxygen 1.9.4-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Networking Design - Johnathan Moore: Docker Images</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
       <script type="text/javascript">
           DoxygenAwesomeDarkModeToggle.init()
       </script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Networking Design - Johnathan Moore
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md__2home_2john_2networking-design_2docker_2docker__journal.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Docker Images</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md196"></a>Docker containers are lightweight solutions I use to either represent network nodes or containers themselves. Containers share the kernal with the underlying OS and other containers. This increases performance. They can also be portable and provide reproducible dependencies. They provide significant isolation like virtual machines, if less complete. </p>
<h1><a class="anchor" id="autotoc_md197"></a>
aaa server</h1>
<p>This is a fork of a docker image "adosztal/aaa". <br  />
 I noticed that bionic is an older Ubuntu release. However when I tried the latest release I found the tacacs package had been removed from the distro. I am continuing to use bionic for labs, but it would not be a good idea to run in the real world. LTS received security updates until April 2023, then security updates became no longer available for free. I believe there are also newer Linux tacacs server packages or addons for free radius that I may look at in the future.</p>
<p>The container uses init.d for controlling services. It is similar to systemd but used for being lightweight. It starts services in the "starter.sh" script.</p>
<p>I ensure the package iproute2 is installed. It is a useful package for adding network interface configuration without editing config files and without restarting the network service. It is used to assign configuration in my script.</p>
<p>I ensure the package openssh-server is installed. This allows ssh into the container.</p>
<p>I ensure the package libpam-radius-auth is installed. This allows login using radius accounts.</p>
<p>Volumes are areas in the container filesystem that will be persistent. They are written to the container hosts filesystem as they are modified in the instance. Unlike other areas in the container filesystem, those will return to what is in the image when the container is shutdown. I add /etc/ssh to make sure my ssh config remains persistent. I also add /var/logs for persistent log files. I try to add "/etc/passwd", "/etc/shadow", "/etc/group", "/etc/gshadow" to make root password changes persistent. However, docker does not allow mounting individual files that are present in the container image (Ubuntu) already. Therefore I decide to mount the entire /etc directory</p>
<p>I begin encountering problems when I added ssh and the network config to the starter script. The ssh service would not stay running, then the network adapters didn't get configured. I added logging to help diagnose and I added a check to whether the interfaces were up before continuing execution. This seemed to fix the issue either directly or due to a delay in execution. I then recognise that now this assumes the eth1 and eth2 exist and are relevant. This is not something that should be in the image, this should be in the instance. For this reason, I move the starter script to the /root directory. This directory is persistent, and can be overridden by the instance configuration. </p>
<h3><a class="anchor" id="autotoc_md198"></a>
Dockerfile</h3>
<div class="fragment"><div class="line">FROM ubuntu:bionic</div>
<div class="line">#FROM ubuntu:focal</div>
<div class="line"># Version with tacacs package required</div>
<div class="line"> </div>
<div class="line">RUN DEBIAN_FRONTEND=noninteractive apt-get update &amp;&amp; apt-get -y --no-install-recommends \</div>
<div class="line">    install telnet curl openssh-client openssh-server nano vim-tiny iputils-ping build-essential \</div>
<div class="line">    net-tools freeradius freeradius-utils tacacs+ iproute2 \</div>
<div class="line">    &amp;&amp; rm -rf /var/lib/apt/lists/*</div>
<div class="line"> </div>
<div class="line">ADD ./clients.conf /etc/freeradius/3.0/clients.conf</div>
<div class="line">ADD ./authorize /etc/freeradius/3.0/mods-config/files/authorize</div>
<div class="line">ADD ./tac_plus.conf /etc/tacacs+/tac_plus.conf</div>
<div class="line">ADD ./runonce.sh /sbin/runonce.sh</div>
<div class="line">ADD ./starter.sh /root/starter.sh</div>
<div class="line">ADD ./empty.sh /root/networkconfig.sh</div>
<div class="line"> </div>
<div class="line">RUN DEBIAN_FRONTEND=noninteractive chmod 755 /sbin/runonce.sh; sleep 1; /sbin/runonce.sh</div>
<div class="line"> </div>
<div class="line">VOLUME [ &quot;/root&quot;, &quot;/etc&quot;, &quot;/var/log&quot; ]</div>
<div class="line">CMD [ &quot;sh&quot;, &quot;-c&quot;, &quot;/root/starter.sh&quot; ]</div>
</div><!-- fragment --> <h3><a class="anchor" id="autotoc_md199"></a>
runonce.sh</h3>
<div class="fragment"><div class="line">touch /var/log/tac_plus.acct</div>
<div class="line">chown freerad:adm /var/log/tac_plus.acct</div>
<div class="line">chmod 644 /var/log/tac_plus.acct</div>
<div class="line">chown freerad:freerad /etc/freeradius/3.0/clients.conf</div>
<div class="line">chmod 644 /etc/freeradius/3.0/clients.conf</div>
<div class="line">chown freerad:freerad /etc/freeradius/3.0/mods-config/files/authorize</div>
<div class="line">chmod 644 /etc/freeradius/3.0/mods-config/files/authorize</div>
<div class="line">chown freerad:freerad /etc/tacacs+/tac_plus.conf</div>
<div class="line">chmod 644 /etc/tacacs+/tac_plus.conf</div>
<div class="line">chmod 755 /root/starter.sh</div>
<div class="line">mkdir -p /run/sshd</div>
<div class="line">chmod 0755 /run/sshd</div>
</div><!-- fragment --> <h3><a class="anchor" id="autotoc_md200"></a>
starter.sh</h3>
<div class="fragment"><div class="line"># Log file path</div>
<div class="line">LOGFILE=&quot;/root/starter.log&quot;</div>
<div class="line">touch $LOGFILE</div>
<div class="line">chmod 644 $LOGFILE</div>
<div class="line"> </div>
<div class="line"># Add a header and timestamp to the log file</div>
<div class="line">echo &quot;===== Service Startup Log =====&quot; &gt; $LOGFILE</div>
<div class="line">echo &quot;Timestamp: $(date)&quot; &gt;&gt; $LOGFILE</div>
<div class="line">echo &quot;==============================&quot; &gt;&gt; $LOGFILE</div>
<div class="line">echo &quot;&quot; &gt;&gt; $LOGFILE</div>
<div class="line"> </div>
<div class="line"># Wait until eth1 and eth2 are up (with a timeout of 30 seconds)</div>
<div class="line">for i in {1..30}; do</div>
<div class="line">    if ip link show eth1 up &amp;&amp; ip link show eth2 up; then</div>
<div class="line">        echo &quot;Interfaces are up&quot; &gt;&gt; $LOGFILE</div>
<div class="line">        INTERFACES_UP=true</div>
<div class="line">        break</div>
<div class="line">    fi</div>
<div class="line">    echo &quot;Waiting for network interfaces to be up...&quot; &gt;&gt; $LOGFILE</div>
<div class="line">    sleep 1</div>
<div class="line">done</div>
<div class="line"> </div>
<div class="line">if [ &quot;$INTERFACES_UP&quot; = false ]; then</div>
<div class="line">    echo &quot;ERROR: Network interfaces eth1 and/or eth2 did not come up after 30 seconds.&quot; &gt;&gt; $LOGFILE</div>
<div class="line">fi</div>
<div class="line"> </div>
<div class="line"># Starting services</div>
<div class="line">bash /root/networkconfig.sh &gt;&gt; $LOGFILE</div>
<div class="line"> </div>
<div class="line">/etc/init.d/freeradius start &gt;&gt; $LOGFILE 2&gt;&amp;1</div>
<div class="line">/etc/init.d/tacacs_plus start &gt;&gt; $LOGFILE 2&gt;&amp;1</div>
<div class="line">/etc/init.d/ssh start &gt;&gt; $LOGFILE 2&gt;&amp;1</div>
<div class="line">clear</div>
<div class="line"> </div>
<div class="line"># Launching shell</div>
<div class="line">cd</div>
<div class="line">exec bash -i</div>
</div><!-- fragment --><p>The other ADD files are defaults and are overwritten by container instances. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.4-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
